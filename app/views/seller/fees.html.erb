<% title @title %>

<% content_for :subnav do %>
	<%= form_tag seller_fees_path, :method => :get do  %>
		Start Date: <%= text_field_tag :start, @start_date, :id => 'start' %>
		<%= submit_tag "Search" %>
	<% end %>
<% end %>

<% unless @market_fees.blank? %>
<h2 class="highlight">
  Total Paid Orders: <%= ph_currency @search.collect(&:bid_total).sum %> /
  Total Market Fee: <%= ph_currency @search.collect(&:fee).sum %>
</h2>

<%= will_paginate @market_fees %>
<%= page_info @market_fees, @sort_order %>

<table id="supplier-fees">
	<thead>
    <%= content_tag :th, 'Vehicle', :class => 'vehicle' %>
		<th>
	    <%= content_tag :div, 'Delivery', :class => 'po-delivery' %>
	    <%= content_tag :div, 'Order Items', :class => 'part' %>
	    <%= content_tag :div, 'Order Total', :class => 'amount-paid' %>
	    <%= content_tag :div, 'Market Fee', :class => 'fee' %>
		</th>
	</thead>
	<% @market_fees.group_by(&:entry).each do |entry, fees| %>
  <tr>
		<td class="vehicle">	
      <%= content_tag :p, (link_to truncate(entry.vehicle, :length => 35), seller_show_path(:id => entry.id)) %>
			<%= content_tag :p, entry.plate_no  %>
		</td>
	  <td>
  	<% fees.group_by(&:order).each do |order, fees| %>
			<div class="po-delivery">
	      <%#= content_tag :p, 'Delivered: ' + order.delivered.strftime('%b %d'), :class => 'instruction'  unless order.delivered.nil? %>
	      <%= content_tag :p, 'Paid: ' + order.paid.strftime('%b %d'), :class => 'instruction highlight'  unless order.paid.nil? %>	
				<%= link_to "View PO # #{order.id}", order %>
			</div>
			<div class="fee-group">
			<% for fee in fees %>
		    <%= content_tag :div, "[ #{fee.line_item.quantity} ] " + fee.line_item.part_name, :class => 'part' %>
		    <%= content_tag :div, (number_to_currency fee.bid_total, :unit => ""), :class => 'amount-paid'  %>
		    <%= content_tag :div, (number_to_currency fee.fee, :unit => ""), :class => 'fee' %>
				<%= content_tag :div, fee.seller.username, :class => 'seller instruction' -%>
			<% end %>
			</div>
		<% end %>
		</td>                          
	</tr>
  <% end %>
	<tr class="totals">
	  <td></td>
	  <td>
	    <%= content_tag :div, 'Sub-Totals', :class => 'po-delivery' %>
			<div class="fee-group">
		    <%= content_tag :div, '', :class => 'part' %>
		    <%= content_tag :div, (ph_currency @market_fees.collect(&:bid_total).sum), :class => 'amount-paid' %>
		    <%= content_tag :div, (ph_currency @market_fees.collect(&:fee).sum), :class => 'fee' %>
			</div>
	  </td>
	</tr>
</table>
<% end %>

<%= will_paginate @market_fees %>

<% content_for :javascripts do %>
	<% stylesheet 'blitzer/jquery-ui-1.8.6.custom' %>
	<script type="text/javascript" charset="utf-8">
	$(function() {
		var dates = $( "#start, #end" ).datepicker({
			dateFormat: "yy-mm-dd",
			maxDate: 0,
			onSelect: function( selectedDate ) {
				var option = this.id == "from" ? "minDate" : "maxDate",
					instance = $( this ).data( "datepicker" ),
					date = $.datepicker.parseDate(
						instance.settings.dateFormat ||
						$.datepicker._defaults.dateFormat,
						selectedDate, instance.settings );
				dates.not( this ).datepicker( "option", option, date );
			}
		});
	});
	</script>
<% end %>